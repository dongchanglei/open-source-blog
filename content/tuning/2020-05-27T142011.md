---
desc: 由 genpost (https://github.com/hidevopsio/genpost) 代码生成器生成
title: MySQL专题(二)
date: 2020-05-27T14:20:11+08:00
author: 董长磊
draft: false
tags:
- MySQL专题(二)
---

## 索引最佳实践

```sql 
CREATE TABLE `employees` (
	`id` int(11) NOT NULL AUTO_INCREMENT,
	`name` varchar(24) NOT NULL DEFAULT '' COMMENT '姓名',
	`age` int(11) NOT NULL DEFAULT '0' COMMENT '年龄',
	`position` varchar(20) NOT NULL DEFAULT '' COMMENT '职位',
	`hire_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '入职时 间',
	PRIMARY KEY (`id`),
	KEY `idx_name_age_position` (`name`,
		`age`,
		`position`)
	USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 0 DEFAULT CHARSET = utf8 COMMENT = '员工记录表';
	
INSERT INTO employees(name,age,position,hire_time) VALUES('LiLei',22,'mana ger',NOW());
INSERT INTO employees(name,age,position,hire_time) VALUES('HanMeimei', 23,'dev',NOW());
INSERT INTO employees(name,age,position,hire_time) VALUES('Lucy',23,'dev',NOW());

-- 查看索引
SHOW INDEX FROM employees;
```

**1、全值匹配**

```sql 
EXPLAIN SELECT * FROM employees WHERE name= 'LiLei';
```
<img src="https://dongchanglei.top/images/quanzhi1.png">

key_len值计算过程：3n+2 --> 3*24+2 = 74

```sql 
EXPLAIN SELECT * FROM employees WHERE name= 'LiLei' AND age = 22;
```

<img src="https://dongchanglei.top/images/quanzhi2.png">
key_len值计算过程：3n+2 + 4 --> 3*24+2+4 = 78 (name和age的长度)

```sql 
EXPLAIN SELECT * FROM employees WHERE name= 'LiLei' AND age = 22 AND position ='manager';
```

<img src="https://dongchanglei.top/images/quanzhi3.png">
key_len值计算过程：3n+2 + 4 + 3n+2 --> 74 + 4 + 62 = 140

**2、最左前缀法则**
如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。
此时表employees中的索引idx_name_age_position普通联合索引
```sql 
EXPLAIN SELECT * FROM employees WHERE age = 22 AND position ='manager';
```
<img src="https://dongchanglei.top/images/zuoqianzhui1.png">
这个SQL可以看出来没有走索引。

```sql 
EXPLAIN SELECT * FROM employees WHERE position = 'manager';
```
<img src="https://dongchanglei.top/images/zuoqianzhui2.png">
这个SQL可以看出来也没有走索引。

```sql 
EXPLAIN SELECT * FROM employees WHERE name = 'LiLei';
```
<img src="https://dongchanglei.top/images/zuoqianzhui3.png">
这个SQL可以看出来走了索引。

**3、不在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描**
正常走索引
```sql 
EXPLAIN SELECT * FROM employees WHERE name = 'LiLei';
```
<img src="https://dongchanglei.top/images/zuoqianzhui3.png">

使用了函数不走索引
1)
```sql 
EXPLAIN SELECT * FROM employees WHERE  left(name,3) = 'LiLei';
```
<img src="https://dongchanglei.top/images/zuoqianzhui4.png">
2)
```sql 
EXPLAIN select * from employees where date(hire_time) ='2018-09-30';
```
<img src="https://dongchanglei.top/images/zuoqianzhui5.png">

给hire_time添加索引
```sql 
ALTER TABLE `employees` ADD INDEX `idx_hire_time` (`hire_time`) USING BTREE ;

EXPLAIN select * from employees where date(hire_time) ='2018-09-30';
```
<img src="https://dongchanglei.top/images/zuoqianzhui5.png">
此时该SQL查询还是不会走索引。
```sql 
EXPLAIN select * from employees where hire_time >='2018-09-30 00:00:00' and hire_time <='2018-09-30 23:59:59'; 
```
<img src="https://dongchanglei.top/images/zuoqianzhui6.png">
这个时候该SQL查询就会走索引了。

还原测试数据
```sql 
 ALTER TABLE `employees` DROP INDEX `idx_hire_time`;
```

